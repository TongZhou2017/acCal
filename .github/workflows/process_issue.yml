name: Issue 自动转换为内容PR

on:
  issues:
    types: [opened]

jobs:
  process_new_conference:
    # 仅处理使用 conference_submission 模板的新Issue
    # 检查 Issue body 中是否包含会议相关字段，或是否有 pending-review 标签
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    
    steps:
      - name: 调试 - 显示 Issue 信息
        run: |
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Labels: ${{ join(github.event.issue.labels.*.name, ',') }}"
          echo "Issue Body (first 500 chars):"
          echo "${{ github.event.issue.body }}" | head -c 500
      
      - name: 检查是否为会议提交 Issue
        id: check_issue
        run: |
          BODY="${{ github.event.issue.body }}"
          LABELS="${{ join(github.event.issue.labels.*.name, ',') }}"
          
          # 检查是否包含会议相关关键词
          if echo "$BODY" | grep -qE "(会议名称|Conference Title|conf_name|一级学科分类|Primary Discipline)" || echo "$LABELS" | grep -q "pending-review"; then
            echo "is_conference=true" >> $GITHUB_OUTPUT
            echo "✅ 检测到会议提交 Issue"
          else
            echo "is_conference=false" >> $GITHUB_OUTPUT
            echo "❌ 未检测到会议提交格式，跳过处理"
          fi
      
      - name: 检查代码
        if: steps.check_issue.outputs.is_conference == 'true'
        uses: actions/checkout@v4

      # 1. 解析 Issue 结构化内容
      - name: 解析Issue表单数据
        if: steps.check_issue.outputs.is_conference == 'true'
        id: parser
        # 此Action能将YAML表单内容解析为JSON输出
        uses: stefanbuck/github-issue-parser@v3 
        with:
          issue-body: ${{ github.event.issue.body }}
          
      # 2. 设置 Python 环境
      - name: 设置 Python 3.11
        if: steps.check_issue.outputs.is_conference == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      # 3. 安装依赖 (如果 issue_to_md.py 需要)
      - name: 安装 Python 依赖
        if: steps.check_issue.outputs.is_conference == 'true'
        run: |
          # 仅需 os, json, datetime, re 等标准库，无需安装额外依赖
          echo "无需安装额外依赖"

      # 4. 运行 Python 脚本生成 Markdown 文件
      - name: 运行转换脚本
        if: steps.check_issue.outputs.is_conference == 'true'
        env:
          ISSUE_DATA: ${{ steps.parser.outputs.jsonString }} # 将解析后的JSON传递给脚本
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          python scripts/issue_to_md.py

      # 4.2. 生成详细的 PR Body
      - name: 生成 PR Body
        if: steps.check_issue.outputs.is_conference == 'true'
        id: pr_body
        env:
          ISSUE_DATA: ${{ steps.parser.outputs.jsonString }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_AUTHOR: ${{ github.event.issue.user.login }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # 运行脚本并捕获输出
          SCRIPT_OUTPUT=$(python scripts/generate_pr_body.py)
          
          # 从输出中提取文件名（格式：PR_BODY_FILE=pr_body_issue_XXX.txt）
          PR_BODY_FILE=$(echo "$SCRIPT_OUTPUT" | grep "^PR_BODY_FILE=" | cut -d'=' -f2)
          
          # 如果没有找到文件名，尝试使用默认文件名（向后兼容）
          if [ -z "$PR_BODY_FILE" ]; then
            PR_BODY_FILE="pr_body_issue_${{ github.event.issue.number }}.txt"
          fi
          
          # 检查文件是否存在
          if [ ! -f "$PR_BODY_FILE" ]; then
            echo "⚠️ 文件 $PR_BODY_FILE 不存在，尝试查找 pr_body*.txt 文件..."
            PR_BODY_FILE=$(ls -t pr_body*.txt 2>/dev/null | head -1)
            if [ -z "$PR_BODY_FILE" ]; then
              echo "❌ 未找到 PR Body 文件"
              exit 1
            fi
            echo "✅ 找到文件: $PR_BODY_FILE"
          fi
          
          # 读取生成的 PR Body 并设置到输出
          PR_BODY=$(cat "$PR_BODY_FILE")
          {
            echo 'body<<PR_BODY_EOF'
            echo "$PR_BODY"
            echo PR_BODY_EOF
          } >> $GITHUB_OUTPUT
          
          # 清理临时文件（可选，保留用于调试）
          # rm -f "$PR_BODY_FILE"

      # 4.5. 排除工作流文件（GitHub 不允许通过 PR 修改工作流）
      - name: 排除工作流文件
        if: steps.check_issue.outputs.is_conference == 'true'
        run: |
          git restore .github/workflows/ || true
          git restore .github/ISSUE_TEMPLATE/ || true

      # 5. 创建 Pull Request
      - name: 创建 Pull Request (PR)
        if: steps.check_issue.outputs.is_conference == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'feat(content): Add new conference from Issue #${{ github.event.issue.number }}'
          title: 'Draft: Add conference from Issue #${{ github.event.issue.number }}'
          body: ${{ steps.pr_body.outputs.body }}
          branch: 'issue-pr-${{ github.event.issue.number }}'
          delete-branch: true
          exclude-paths: |
            .github/workflows/**
            .github/ISSUE_TEMPLATE/**
