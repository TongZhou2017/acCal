name: è‡ªåŠ¨å‘å¸ƒä¼šè®®

on:
  pull_request:
    types: [closed]

jobs:
  publish_conference:
    # ä»…å¤„ç†åˆå¹¶åˆ° main åˆ†æ”¯çš„ PR
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä»¥ä¾¿è®¿é—® PR base å’Œ merge SHA
      
      - name: æŸ¥æ‰¾æ–°æ·»åŠ çš„ä¼šè®®æ–‡ä»¶
        id: find_conferences
        run: |
          # è·å– PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          MERGE_SHA="${{ github.event.pull_request.merge_commit_sha }}"
          
          echo "PR Base SHA: $BASE_SHA"
          echo "PR Merge SHA: $MERGE_SHA"
          echo "å½“å‰ HEAD: $(git rev-parse HEAD)"
          
          # ç¡®ä¿ SHA å­˜åœ¨
          if ! git cat-file -e "$BASE_SHA" 2>/dev/null; then
            echo "âš ï¸ Base SHA ä¸å­˜åœ¨ï¼Œå°è¯•è·å–..."
            git fetch origin "$BASE_SHA" 2>&1 || echo "æ— æ³•è·å– Base SHA"
          fi
          
          if ! git cat-file -e "$MERGE_SHA" 2>/dev/null; then
            echo "âš ï¸ Merge SHA ä¸å­˜åœ¨ï¼Œå°è¯•è·å–..."
            git fetch origin "$MERGE_SHA" 2>&1 || echo "æ— æ³•è·å– Merge SHA"
          fi
          
          # å°è¯•å¤šç§æ–¹æ³•è·å– PR ä¸­æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          PR_FILES=""
          
          # æ–¹æ³•1: ä½¿ç”¨ PR base å’Œ merge SHA
          if git cat-file -e "$BASE_SHA" 2>/dev/null && git cat-file -e "$MERGE_SHA" 2>/dev/null; then
            echo "âœ… ä½¿ç”¨ PR base å’Œ merge SHA è·å–æ–‡ä»¶åˆ—è¡¨"
            PR_FILES=$(git diff --name-only --diff-filter=AM "$BASE_SHA" "$MERGE_SHA" 2>&1)
            if [ $? -eq 0 ] && [ -n "$PR_FILES" ]; then
              echo "æˆåŠŸè·å–æ–‡ä»¶åˆ—è¡¨"
            else
              echo "æ–¹æ³•1å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
              PR_FILES=""
            fi
          fi
          
          # æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œä½¿ç”¨ HEAD å’Œ HEAD~1ï¼ˆåˆå¹¶åçš„æœ€æ–°æäº¤ï¼‰
          if [ -z "$PR_FILES" ]; then
            echo "å°è¯•ä½¿ç”¨ HEAD å’Œ HEAD~1"
            if git rev-parse HEAD~1 >/dev/null 2>&1; then
              PR_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD 2>&1)
              if [ $? -eq 0 ] && [ -n "$PR_FILES" ]; then
                echo "âœ… ä½¿ç”¨ HEAD~1 å’Œ HEAD æˆåŠŸè·å–æ–‡ä»¶åˆ—è¡¨"
              else
                PR_FILES=""
              fi
            fi
          fi
          
          # æ–¹æ³•3: å¦‚æœå‰ä¸¤ç§æ–¹æ³•éƒ½å¤±è´¥ï¼Œä½¿ç”¨ GitHub API è·å–æ–‡ä»¶åˆ—è¡¨
          if [ -z "$PR_FILES" ]; then
            echo "å°è¯•ä½¿ç”¨ GitHub API è·å–æ–‡ä»¶åˆ—è¡¨"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_FILES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" | \
              jq -r '.[] | select(.status == "added" or .status == "modified") | .filename' 2>/dev/null || echo "")
            if [ -n "$PR_FILES" ]; then
              echo "âœ… ä½¿ç”¨ GitHub API æˆåŠŸè·å–æ–‡ä»¶åˆ—è¡¨"
            fi
          fi
          
          echo "PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶:"
          echo "$PR_FILES"
          
          CONFERENCE_FILES=""
          if [ -n "$PR_FILES" ]; then
            # å¤„ç†æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯èƒ½åŒ…å«æ¢è¡Œç¬¦ï¼‰
            while IFS= read -r file || [ -n "$file" ]; do
              # è·³è¿‡ç©ºè¡Œ
              [ -z "$file" ] && continue
              # ä½¿ç”¨æ›´çµæ´»çš„åŒ¹é…æ¨¡å¼
              if [[ "$file" == _conferences/*.md ]] || [[ "$file" =~ ^_conferences/.*\.md$ ]]; then
                CONFERENCE_FILES="$CONFERENCE_FILES $file"
              fi
            done <<< "$PR_FILES"
          fi
          
          # å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœå‰é¢éƒ½æ²¡æ‰¾åˆ°æ–‡ä»¶ï¼Œæ£€æŸ¥æœ€è¿‘åˆå¹¶çš„æäº¤
          if [ -z "$CONFERENCE_FILES" ]; then
            echo "âš ï¸ é€šè¿‡ diff æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œå°è¯•æ£€æŸ¥æœ€è¿‘åˆå¹¶çš„æäº¤..."
            MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
            if [ -n "$MERGE_COMMIT" ] && git cat-file -e "$MERGE_COMMIT" 2>/dev/null; then
              echo "æ£€æŸ¥åˆå¹¶æäº¤ $MERGE_COMMIT ä¸­çš„æ–‡ä»¶..."
              RECENT_FILES=$(git diff-tree --no-commit-id --name-only --diff-filter=AM -r "$MERGE_COMMIT" | grep "^_conferences/.*\.md$" || echo "")
              if [ -n "$RECENT_FILES" ]; then
                echo "âœ… åœ¨åˆå¹¶æäº¤ä¸­æ‰¾åˆ°æ–‡ä»¶:"
                echo "$RECENT_FILES"
                CONFERENCE_FILES="$RECENT_FILES"
              fi
            fi
          fi
          
          # æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆï¼šæ£€æŸ¥ HEAD æäº¤ä¸­çš„æ–°æ–‡ä»¶
          if [ -z "$CONFERENCE_FILES" ]; then
            echo "âš ï¸ ä»æœªæ‰¾åˆ°æ–‡ä»¶ï¼Œæ£€æŸ¥ HEAD æäº¤..."
            HEAD_FILES=$(git diff-tree --no-commit-id --name-only --diff-filter=A -r HEAD | grep "^_conferences/.*\.md$" || echo "")
            if [ -n "$HEAD_FILES" ]; then
              echo "âœ… åœ¨ HEAD æäº¤ä¸­æ‰¾åˆ°æ–°æ–‡ä»¶:"
              echo "$HEAD_FILES"
              CONFERENCE_FILES="$HEAD_FILES"
            fi
          fi
          
          if [ -z "$CONFERENCE_FILES" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âŒ æœ€ç»ˆæœªæ‰¾åˆ°æ–°çš„ä¼šè®®æ–‡ä»¶"
            # å°è¯•æŸ¥æ‰¾æ‰€æœ‰ _conferences ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼ˆç”¨äºè°ƒè¯•ï¼‰
            echo "è°ƒè¯•ä¿¡æ¯ - æ£€æŸ¥ _conferences ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶:"
            ls -la _conferences/ 2>&1 || echo "ç›®å½•ä¸å­˜åœ¨"
            echo ""
            echo "è°ƒè¯•ä¿¡æ¯ - æœ€è¿‘çš„æäº¤:"
            git log --oneline -5 --name-only --pretty=format:"%h %s" | head -20
          else
            echo "found=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFERENCE_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°ä¼šè®®æ–‡ä»¶: $CONFERENCE_FILES"
          fi
      
      - name: ç¡®ä¿ draft ä¸º falseï¼ˆå®‰å…¨æªæ–½ï¼‰
        if: steps.find_conferences.outputs.found == 'true'
        id: update_draft
        run: |
          FILES="${{ steps.find_conferences.outputs.files }}"
          CHANGED=false
          
          echo "ğŸ“‹ å‡†å¤‡å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨:"
          echo "$FILES"
          echo ""
          
          # ä½¿ç”¨ while read å¾ªç¯å¤„ç†æ–‡ä»¶åˆ—è¡¨ï¼ˆæ”¯æŒå¤šè¡Œå’Œç©ºæ ¼ï¼‰
          while IFS= read -r file || [ -n "$file" ]; do
            # å»é™¤é¦–å°¾ç©ºæ ¼å’Œæ¢è¡Œç¬¦
            file=$(echo "$file" | xargs)
            
            # è·³è¿‡ç©ºè¡Œ
            [ -z "$file" ] && continue
            
            echo "ğŸ“ å¤„ç†æ–‡ä»¶: $file"
            
            if [ ! -f "$file" ]; then
              echo "  âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
              continue
            fi
            
            # æ£€æŸ¥å½“å‰ draft çŠ¶æ€ï¼ˆä½œä¸ºå®‰å…¨æªæ–½ï¼Œç¡®ä¿ draft å§‹ç»ˆä¸º falseï¼‰
            if grep -q "^draft: true" "$file"; then
              echo "  å½“å‰çŠ¶æ€: draft: trueï¼ˆè‡ªåŠ¨ä¿®æ­£ä¸º falseï¼‰"
              # ä½¿ç”¨ sed å°† draft: true æ”¹ä¸º draft: false
              # macOS å’Œ Linux å…¼å®¹çš„ sed å‘½ä»¤
              if [[ "$OSTYPE" == "darwin"* ]]; then
                sed -i '' 's/^draft: true$/draft: false/' "$file"
              else
                sed -i 's/^draft: true$/draft: false/' "$file"
              fi
              echo "  âœ… å·²å°† draft è®¾ç½®ä¸º false"
              CHANGED=true
            elif grep -q "^draft: false" "$file"; then
              echo "  â„¹ï¸  å·²ç»æ˜¯ draft: falseï¼Œè·³è¿‡"
            else
              echo "  âš ï¸  æœªæ‰¾åˆ° draft å­—æ®µï¼Œæ·»åŠ  draft: false"
              # åœ¨ç¬¬ä¸€ä¸ª --- åæ·»åŠ  draft: false
              # ä½¿ç”¨ awk æ¥æ·»åŠ  draft: falseï¼ˆæ›´å¯é ï¼Œé¿å… YAML å¤šè¡Œé—®é¢˜ï¼‰
              awk '/^---$/ && !seen { print; print "draft: false"; seen=1; next } 1' "$file" > "$file.tmp" && mv "$file.tmp" "$file"
              CHANGED=true
            fi
            
            # æ˜¾ç¤ºä¿®æ”¹åçš„å†…å®¹ï¼ˆå‰20è¡Œï¼‰
            echo "  æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
            head -20 "$file" | grep -E "(draft:|title:)" || echo "  (æœªæ‰¾åˆ°ç›¸å…³å­—æ®µ)"
            echo ""
          done <<< "$FILES"
          
          if [ "$CHANGED" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… æœ‰æ–‡ä»¶è¢«ä¿®æ”¹"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  æ²¡æœ‰æ–‡ä»¶éœ€è¦ä¿®æ”¹"
          fi
      
      - name: éªŒè¯ä¿®æ”¹
        if: steps.find_conferences.outputs.found == 'true' && steps.update_draft.outputs.changed == 'true'
        run: |
          FILES="${{ steps.find_conferences.outputs.files }}"
          echo "ğŸ” éªŒè¯æ–‡ä»¶ä¿®æ”¹çŠ¶æ€:"
          
          while IFS= read -r file || [ -n "$file" ]; do
            file=$(echo "$file" | xargs)
            [ -z "$file" ] && continue
            
            if [ -f "$file" ]; then
              if grep -q "^draft: false" "$file"; then
                echo "  âœ… $file - draft: false"
              elif grep -q "^draft: true" "$file"; then
                echo "  âš ï¸  $file - ä»ç„¶æ˜¯ draft: trueï¼ˆå¯èƒ½ä¿®æ”¹å¤±è´¥ï¼‰"
              else
                echo "  âš ï¸  $file - æœªæ‰¾åˆ° draft å­—æ®µ"
              fi
            fi
          done <<< "$FILES"
      
      - name: æäº¤æ›´æ”¹
        if: steps.find_conferences.outputs.found == 'true' && steps.update_draft.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰ä¿®æ”¹çš„ä¼šè®®æ–‡ä»¶
          FILES="${{ steps.find_conferences.outputs.files }}"
          echo "ğŸ“‹ å‡†å¤‡æäº¤çš„æ–‡ä»¶:"
          
          # ä½¿ç”¨ while read å¾ªç¯å¤„ç†æ–‡ä»¶åˆ—è¡¨
          while IFS= read -r file || [ -n "$file" ]; do
            file=$(echo "$file" | xargs)
            [ -z "$file" ] && continue
            
            if [ -f "$file" ]; then
              echo "  + $file"
              git add "$file"
            else
              echo "  âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done <<< "$FILES"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            echo ""
            echo "ğŸ“ æäº¤æ›´æ”¹..."
            git commit -m "chore: è‡ªåŠ¨å‘å¸ƒä¼šè®® (æ¥è‡ª PR #${{ github.event.pull_request.number }})"
            echo "ğŸš€ æ¨é€æ›´æ”¹..."
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
          fi
      
      - name: åˆ é™¤ PR åˆ†æ”¯
        run: |
          PR_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "å‡†å¤‡åˆ é™¤åˆ†æ”¯: $PR_BRANCH"
          
          # æ£€æŸ¥åˆ†æ”¯åç§°æ˜¯å¦åŒ¹é… issue-pr-* æ¨¡å¼ï¼ˆé¿å…è¯¯åˆ å…¶ä»–åˆ†æ”¯ï¼‰
          if [[ "$PR_BRANCH" =~ ^issue-pr-[0-9]+$ ]]; then
            echo "âœ… ç¡®è®¤æ˜¯è‡ªåŠ¨åˆ›å»ºçš„ PR åˆ†æ”¯ï¼Œå‡†å¤‡åˆ é™¤"
            
            # ä½¿ç”¨ GitHub API åˆ é™¤åˆ†æ”¯ï¼ˆæ›´å¯é ï¼‰
            RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/$PR_BRANCH")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "404" ]; then
              echo "âœ… åˆ†æ”¯ $PR_BRANCH å·²åˆ é™¤ï¼ˆHTTP $HTTP_CODEï¼‰"
            else
              echo "âš ï¸  åˆ é™¤åˆ†æ”¯å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE"
              echo "å“åº”: $BODY"
              # å°è¯•ä½¿ç”¨ git push åˆ é™¤ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
              echo "å°è¯•ä½¿ç”¨ git push åˆ é™¤..."
              git push origin --delete "$PR_BRANCH" 2>&1 || echo "git push åˆ é™¤ä¹Ÿå¤±è´¥"
            fi
          else
            echo "â„¹ï¸  è·³è¿‡åˆ é™¤éè‡ªåŠ¨åˆ›å»ºçš„åˆ†æ”¯: $PR_BRANCH"
            echo "ï¼ˆä»…åˆ é™¤ issue-pr-* æ ¼å¼çš„åˆ†æ”¯ï¼‰"
          fi

