name: è‡ªåŠ¨å‘å¸ƒä¼šè®®

on:
  pull_request:
    types: [closed]

jobs:
  publish_conference:
    # ä»…å¤„ç†åˆå¹¶åˆ° main åˆ†æ”¯çš„ PR
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: æ£€æŸ¥ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
      
      - name: æŸ¥æ‰¾æ–°æ·»åŠ çš„ä¼šè®®æ–‡ä»¶
        id: find_conferences
        run: |
          # è·å– PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶
          echo "PR Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "PR Merge SHA: ${{ github.event.pull_request.merge_commit_sha }}"
          
          # è·å– PR ä¸­æ–°å¢æˆ–ä¿®æ”¹çš„æ–‡ä»¶
          PR_FILES=$(git diff --name-only --diff-filter=AM ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.merge_commit_sha }} || git diff --name-only --diff-filter=AM HEAD~1 HEAD)
          
          echo "PR ä¸­ä¿®æ”¹çš„æ–‡ä»¶:"
          echo "$PR_FILES"
          
          CONFERENCE_FILES=""
          for file in $PR_FILES; do
            if [[ "$file" == _conferences/*.md ]]; then
              CONFERENCE_FILES="$CONFERENCE_FILES $file"
            fi
          done
          
          if [ -z "$CONFERENCE_FILES" ]; then
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ–°çš„ä¼šè®®æ–‡ä»¶"
            # å°è¯•æŸ¥æ‰¾æ‰€æœ‰ _conferences ç›®å½•ä¸‹çš„æ–‡ä»¶
            echo "æ£€æŸ¥ _conferences ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶:"
            ls -la _conferences/ || echo "ç›®å½•ä¸å­˜åœ¨"
          else
            echo "found=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CONFERENCE_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "âœ… æ‰¾åˆ°ä¼šè®®æ–‡ä»¶: $CONFERENCE_FILES"
          fi
      
      - name: è‡ªåŠ¨å°† draft æ”¹ä¸º false
        if: steps.find_conferences.outputs.found == 'true'
        id: update_draft
        run: |
          FILES="${{ steps.find_conferences.outputs.files }}"
          CHANGED=false
          
          for file in $FILES; do
            file=$(echo "$file" | xargs)  # å»é™¤ç©ºæ ¼
            if [ -f "$file" ]; then
              echo "ğŸ“ å¤„ç†æ–‡ä»¶: $file"
              
              # æ£€æŸ¥å½“å‰ draft çŠ¶æ€
              if grep -q "^draft: true" "$file"; then
                echo "  å½“å‰çŠ¶æ€: draft: true"
                # ä½¿ç”¨ sed å°† draft: true æ”¹ä¸º draft: false
                sed -i 's/^draft: true$/draft: false/' "$file"
                echo "  âœ… å·²å°† draft è®¾ç½®ä¸º false"
                CHANGED=true
              elif grep -q "^draft: false" "$file"; then
                echo "  â„¹ï¸  å·²ç»æ˜¯ draft: falseï¼Œè·³è¿‡"
              else
                echo "  âš ï¸  æœªæ‰¾åˆ° draft å­—æ®µï¼Œæ·»åŠ  draft: false"
                # åœ¨ front matter ä¸­æ·»åŠ  draft: false
                sed -i '/^---$/a draft: false' "$file" | head -1
                CHANGED=true
              fi
              
              # æ˜¾ç¤ºä¿®æ”¹åçš„å†…å®¹ï¼ˆå‰20è¡Œï¼‰
              echo "  æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
              head -20 "$file" | grep -E "(draft:|title:)" || echo "  (æœªæ‰¾åˆ°ç›¸å…³å­—æ®µ)"
            else
              echo "âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: $file"
            fi
          done
          
          if [ "$CHANGED" = "true" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: æäº¤æ›´æ”¹
        if: steps.find_conferences.outputs.found == 'true' && steps.update_draft.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰ä¿®æ”¹çš„ä¼šè®®æ–‡ä»¶
          FILES="${{ steps.find_conferences.outputs.files }}"
          for file in $FILES; do
            file=$(echo "$file" | xargs)
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "â„¹ï¸  æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "chore: è‡ªåŠ¨å‘å¸ƒä¼šè®® (æ¥è‡ª PR #${{ github.event.pull_request.number }})"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ›´æ”¹"
          fi

